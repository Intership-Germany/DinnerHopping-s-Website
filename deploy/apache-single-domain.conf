# Un seul domaine (dinnerhoppings.acrevon.fr) qui sert le frontend et reverse proxy /api vers FastAPI
<VirtualHost *:80>
    ServerName dinnerhoppings.acrevon.fr
    ServerAlias www.dinnerhoppings.acrevon.fr

    ProxyPassMatch "^/.well-known/acme-challenge/" "!"

    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Port "80"

    ProxyPass "/chats/ws" "ws://127.0.0.1:8000/chats/ws"
    ProxyPassReverse "/chats/ws" "ws://127.0.0.1:8000/chats/ws"

    ProxyPass "/api/" "http://127.0.0.1:8000/"
    ProxyPassReverse "/api/" "http://127.0.0.1:8000/"

    ProxyPass "/" "http://127.0.0.1:40332/" retry=0 keepalive=On
    ProxyPassReverse "/" "http://127.0.0.1:40332/"
</VirtualHost>

<VirtualHost *:443>
    ServerName dinnerhoppings.acrevon.fr
    ServerAlias www.dinnerhoppings.acrevon.fr

    SSLEngine On
    SSLCertificateFile /etc/letsencrypt/live/dinnerhoppings.acrevon.fr/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/dinnerhoppings.acrevon.fr/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    # Headers sécurité
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    ProxyPassMatch "^/.well-known/acme-challenge/" "!"

    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"

    # WebSockets backend
    ProxyPass "/chats/ws" "ws://127.0.0.1:8000/chats/ws"
    ProxyPassReverse "/chats/ws" "ws://127.0.0.1:8000/chats/ws"

    # API backend
    ProxyPass "/api/" "http://127.0.0.1:8000/"
    ProxyPassReverse "/api/" "http://127.0.0.1:8000/"

    # Frontend SPA/HTML served by Docker container on port 40332
    ProxyPass "/" "http://127.0.0.1:40332/" retry=0 keepalive=On
    ProxyPassReverse "/" "http://127.0.0.1:40332/"

    ErrorLog  /var/log/apache2/site_error.log
    CustomLog /var/log/apache2/site_access.log combined
</VirtualHost>
