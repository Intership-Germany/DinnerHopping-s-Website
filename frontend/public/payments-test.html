<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>DinnerHopping - Payments Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="./js/config.js"></script>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 1.5rem; }
        h1 { margin-top: 0; }
        fieldset { border: 1px solid #ccc; padding: .75rem 1rem 1rem; margin-bottom: 1.25rem; border-radius: 8px; }
        legend { font-weight: 600; }
        label { display:block; margin-top:.5rem; font-size:.85rem; text-transform:uppercase; letter-spacing:.5px; color:#444; }
        input, select { width:100%; padding:.5rem; border:1px solid #bbb; border-radius:4px; font-size:.95rem; }
        button { cursor:pointer; padding:.5rem .9rem; border:1px solid #0d63d6; background:#0d6efd; color:#fff; border-radius:4px; font-size:.9rem; margin-top:.5rem; }
        button.secondary { background:#555; border-color:#555; }
        button:disabled { opacity:.5; cursor:not-allowed; }
        .row { display:flex; gap:1rem; flex-wrap:wrap; }
        .row > div { flex:1 1 240px; }
        #log { white-space:pre-wrap; background:#111; color:#eee; padding:1rem; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; max-height:360px; overflow:auto; }
        .ok { color:#4cc159; }
        .err { color:#ff6666; }
        .badge { display:inline-block; background:#eee; padding:2px 6px; border-radius:4px; font-size:.7rem; margin-left:.25rem; }
        .inline { display:inline-flex; gap:.5rem; align-items:center; }
    </style>
</head>
<body>
    <h1>Payments End-to-End Test</h1>
    <p style="max-width:760px">Manual test tool covering: login, profile read, event creation (admin), registration, and PayPal order creation (SDK).<br/>Make sure PayPal env variables are configured on the backend. For the <strong>Buttons</strong> flow, the SDK loads dynamically after login.</p>

    <fieldset>
        <legend>1. Login</legend>
        <div class="row"></div>
            <div>
                <label>Email</label>
                <input id="email" value="info@acrevon.fr" />
            </div>
            <div>
                <label>Password</label>
                <input id="password" type="password" value="Azertyuiop12!" />
            </div>
        </div>
        <button id="btn-login">Login</button>
        <div class="inline" style="margin-top:.5rem;">
            <span>Token: <span id="token-badge" class="badge">(none)</span></span>
            <button id="btn-profile" class="secondary" disabled>Profile</button>
        </div>
    </fieldset>

    <fieldset>
        <legend>2. Event (admin)</legend>
        <div class="row">
            <div>
                <label>Title</label>
                <input id="event-title" value="Event Test" />
            </div>
            <div>
                <label>Date (YYYY-MM-DD)</label>
                <input id="event-date" value="2032-01-01" />
            </div>
            <div>
                <label>Capacity</label>
                <input id="event-cap" type="number" value="10" />
            </div>
            <div>
                <label>Fee (cents)</label>
                <input id="event-fee" type="number" value="1500" />
            </div>
        </div>
        <button id="btn-create-event" disabled>Create Event</button>
        <div style="margin-top:.5rem">Event ID: <span id="event-id" class="badge">(none)</span></div>
    </fieldset>

    <fieldset>
        <legend>3. Registration</legend>
        <div class="row">
            <div>
                <label>Event ID (existing)</label>
                <input id="event-id-input" placeholder="Use above or paste" />
            </div>
        </div>
        <button id="btn-register" disabled>Create Solo Registration</button>
        <div style="margin-top:.5rem">Registration ID: <span id="reg-id" class="badge">(none)</span></div>
    </fieldset>

    <fieldset>
        <legend>4. PayPal - Buttons (Orders API)</legend>
        <p style="margin-top:0">Uses the PayPal JS SDK. Optionally enter a different registration_id. Only one order per registration.</p>
        <label>Registration ID (override)</label>
        <input id="reg-id-buttons" placeholder="Leave empty to use above" />
        <div id="paypal-buttons" style="margin-top:1rem"></div>
    </fieldset>

    <fieldset>
        <legend>Log</legend>
        <div id="log"></div>
    </fieldset>

<script>
(function(){
    const backend = (window.BACKEND_BASE_URL || window.location.origin).replace(/\/$/, '');
    const logEl = document.getElementById('log');
    function log(msg, obj, level='info'){ const ts=new Date().toISOString(); logEl.textContent += `[${ts}] ${msg}`+(obj?`\n${JSON.stringify(obj,null,2)}`:'')+"\n"; logEl.scrollTop = logEl.scrollHeight; }
    function byId(id){ return document.getElementById(id); }
    let token = null;

    function authHeaders(h={}){ if(token) h['Authorization'] = 'Bearer '+token; h['Content-Type']='application/json'; return h; }

    async function login(){
        const email = byId('email').value.trim();
        const password = byId('password').value;
        try {
            const r = await fetch(`${backend}/login`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:email, password})});
            const j = await r.json().catch(()=>({}));
            if(!r.ok){ log('Login failed', j, 'err'); return; }
            token = j.access_token; byId('token-badge').textContent = token?token.slice(0,18)+'…':'(none)';
            byId('btn-profile').disabled=false; byId('btn-create-event').disabled=false; byId('btn-register').disabled=false;
            log('Login ok', { token_head: token.slice(0,20) });
            await loadPaypalSdk();
        } catch(e){ log('Login exception', {error:String(e)}, 'err'); }
    }

    async function profile(){
        try {
            const r = await fetch(`${backend}/me`, { headers: authHeaders() });
            const j = await r.json().catch(()=>({}));
            if(!r.ok){ log('Profile failed', j, 'err'); return; }
            log('Profile', j);
        } catch(e){ log('Profile exception', {error:String(e)}, 'err'); }
    }

    async function createEvent(){
        const body = { title: byId('event-title').value.trim() || 'Event Test', date: byId('event-date').value.trim(), capacity: parseInt(byId('event-cap').value||'10',10), fee_cents: parseInt(byId('event-fee').value||'1500',10), status: 'open' };
        try {
            const r = await fetch(`${backend}/events`, { method:'POST', headers: authHeaders(), body: JSON.stringify(body)});
            const j = await r.json().catch(()=>({}));
            if(!r.ok){ log('Create event failed', j, 'err'); return; }
            byId('event-id').textContent = j.id || '(?)';
            byId('event-id-input').value = j.id || '';
            log('Event created', j);
        } catch(e){ log('Create event exception', {error:String(e)}, 'err'); }
    }

    async function registerSolo(){
        const evId = byId('event-id-input').value.trim(); if(!evId){ log('Registration: missing event_id'); return; }
        try {
            const r = await fetch(`${backend}/registrations/solo`, { method:'POST', headers: authHeaders(), body: JSON.stringify({event_id: evId})});
            const j = await r.json().catch(()=>({}));
            if(!r.ok){ log('Registration failed', j, 'err'); return; }
            byId('reg-id').textContent = j.registration_id || '(?)';
            log('Registration ok', j);
        } catch(e){ log('Registration exception', {error:String(e)}, 'err'); }
    }

    let paypalLoaded=false;
    async function loadPaypalSdk(){
        if(paypalLoaded) return;
        // fetch config
        let cfg; try { const r = await fetch(`${backend}/payments/paypal/config`, {headers: authHeaders()}); if(!r.ok) throw new Error('config'); cfg = await r.json(); } catch(e){ log('PayPal config failed', {error:String(e)}, 'err'); return; }
        await new Promise((res, rej)=>{ const s=document.createElement('script'); const params=new URLSearchParams({'client-id':cfg.clientId, currency: cfg.currency}); s.src=`https://www.paypal.com/sdk/js?${params.toString()}`; s.onload=res; s.onerror=()=>rej(new Error('sdk load')); document.head.appendChild(s); });
        paypalLoaded=true; log('PayPal SDK loaded');
        renderButtons();
    }

    function renderButtons(){
        if(!window.paypal) return;
        paypal.Buttons({
            createOrder: async () => {
                const override = byId('reg-id-buttons').value.trim();
                const regId = override || (byId('reg-id').textContent || '').replace('…','').trim();
                if(!regId || regId==="(none)") { alert('Registration ID requis'); throw new Error('missing reg'); }
                const body = { registration_id: regId, amount_cents: 0, provider: 'paypal', currency: 'EUR', flow: 'order' };
                const r = await fetch(`${backend}/payments`, { method:'POST', headers: authHeaders(), body: JSON.stringify(body) });
                const j = await r.json().catch(()=>({}));
                if(!r.ok){ log('createOrder (Buttons) échec', j, 'err'); throw new Error('create order fail'); }
                log('Order PayPal créé (Buttons)', j);
                const next = j && j.next_action ? j.next_action : {};
                const orderId = next.type === 'paypal_order' ? next.order_id : (j.order_id || j.id);
                if(!orderId) throw new Error('missing order id');
                return orderId;
            },
            onApprove: async data => {
                const r = await fetch(`${backend}/payments/paypal/orders/${encodeURIComponent(data.orderID)}/capture`, { method:'POST', headers: authHeaders() });
                const j = await r.json().catch(()=>({}));
                if(!r.ok){ log('capture (Buttons) failed', j, 'err'); return; }
                log('PayPal capture (Buttons)', j);
            },
            onError: err => { log('PayPal Buttons error', {error:String(err)}, 'err'); }
        }).render('#paypal-buttons');
    }

    // Bind UI
    byId('btn-login').onclick = login;
    byId('btn-profile').onclick = profile;
    byId('btn-create-event').onclick = createEvent;
    byId('btn-register').onclick = registerSolo;
})();
</script>
</body>
</html>
