<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dinnerhopping - Login/Sign Up</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Config variables (auto-generated) -->
    <script src="config.js"></script>
    <script src="auth.js"></script>
    <script src="debug-banner.js"></script>
    <script src="includes.js" defer></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f0f4f7;
        }
        .hero-gradient {
            background-image: linear-gradient(135deg, #172a3a, #f46f47);
        }
        [hidden] {
            display: none !important;
        }
    </style>
 </head>
 <body class="text-[#172a3a] flex flex-col min-h-screen">
     <div id="app" class="flex flex-col flex-grow">
         <!-- Site Header -->
         <div data-include="partials/header.html"></div>

         <main class="flex-grow w-full px-6 pt-10 pb-20 mt-16">
             <!-- Login/Sign-up Section -->
             <section id="login-page" class="max-w-xl mx-auto">
                 <h1 class="text-3xl font-bold mb-8 text-center">Join the fun.</h1>
                 <div class="bg-white p-6 rounded-2xl shadow-xl">
                     <div class="flex justify-center mb-6 gap-2 bg-gray-100 p-1 rounded-full">
                         <button id="show-login-btn" class="px-6 py-2 font-semibold text-sm rounded-full transition-colors duration-300 bg-[#f46f47] text-white">Login</button>
                         <button id="show-signup-btn" class="px-6 py-2 font-semibold text-sm rounded-full transition-colors duration-300 text-[#4c4c4c] hover:bg-white">Sign Up</button>
                     </div>

                     <!-- Login Form -->
                     <form id="login-form" class="space-y-4" aria-label="Login form">
                         <div>
                             <label for="login-email" class="block mb-1 text-sm font-semibold text-[#172a3a]">Email address</label>
                             <input id="login-email" type="email" placeholder="Enter your email" autocomplete="email" required class="w-full p-4 border rounded-xl focus:ring-2 focus:ring-[#f46f47] outline-none bg-gray-50">
                         </div>
                         <div>
                             <label for="login-password" class="block mb-1 text-sm font-semibold text-[#172a3a]">Password</label>
                             <input id="login-password" type="password" placeholder="Enter your password" autocomplete="current-password" required class="w-full p-4 border rounded-xl focus:ring-2 focus:ring-[#f46f47] outline-none bg-gray-50">
                         </div>
                         <button type="submit" class="w-full py-4 bg-[#f46f47] text-white font-bold rounded-xl shadow-lg transition-transform duration-300 hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-[#f46f47]/40">Login</button>
                         <button type="button" id="resend-verif-btn" class="hidden w-full py-3 border border-[#f46f47] text-[#f46f47] font-semibold rounded-xl transition-colors duration-300 hover:bg-[#f46f47] hover:text-white">Resend verification email</button>
                         <p class="text-xs text-center text-gray-500">By logging in you agree to our <a href="#" class="text-[#f46f47] font-semibold hover:underline">Terms</a>.</p>
                     </form>

                     <!-- Sign-up Form (hidden by default) -->
                     <form id="signup-form" class="space-y-4" hidden aria-label="Sign up form">
                         <div class="flex gap-3">
                             <div class="flex-1">
                                 <label for="signup-lastname" class="block mb-1 text-sm font-semibold text-[#172a3a]">Last name</label>
                                 <input id="signup-lastname" type="text" placeholder="Grimm" autocomplete="family-name" required class="w-full p-4 border rounded-xl focus:ring-2 focus:ring-[#f46f47] outline-none bg-gray-50">
                             </div>
                             <div class="flex-1">
                                 <label for="signup-firstname" class="block mb-1 text-sm font-semibold text-[#172a3a]">First name</label>
                                 <input id="signup-firstname" type="text" placeholder="Arthur" autocomplete="given-name" required class="w-full p-4 border rounded-xl focus:ring-2 focus:ring-[#f46f47] outline-none bg-gray-50">
                             </div>
                         </div>
                         <div>
                             <label for="signup-email" class="block mb-1 text-sm font-semibold text-[#172a3a]">Email address</label>
                             <input id="signup-email" type="email" placeholder="arthur.g@email.de" autocomplete="email" required class="w-full p-4 border rounded-xl focus:ring-2 focus:ring-[#f46f47] outline-none bg-gray-50">
                         </div>
                         <div>
                             <label for="signup-password" class="block mb-1 text-sm font-semibold text-[#172a3a]">Password</label>
                             <input id="signup-password" type="password" placeholder="Create a password" autocomplete="new-password" required class="w-full p-4 border rounded-xl focus:ring-2 focus:ring-[#f46f47] outline-none bg-gray-50">
                         </div>
                         <button type="submit" class="w-full py-4 bg-[#f46f47] text-white font-bold rounded-xl shadow-lg transition-transform duration-300 hover:scale-[1.02] focus:outline-none focus:ring-4 focus:ring-[#f46f47]/40">Create Account</button>
                         <p class="text-xs text-center text-gray-500">Creating an account means you accept our <a href="#" class="text-[#f46f47] font-semibold hover:underline">Privacy Policy</a>.</p>
                     </form>
                 </div>
             </section>
         </main>

         <!-- Footer -->
         <div data-include="partials/footer.html"></div>
     </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginPage = document.getElementById('login-page');
            
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');
            const showLoginBtn = document.getElementById('show-login-btn');
            const showSignupBtn = document.getElementById('show-signup-btn');
            const resendBtn = document.getElementById('resend-verif-btn');
            // Provide a safe debug logger so calls to dbg.logReq do not break the flow
            if (!window.dbg) {
                window.dbg = { logReq: (...args) => console.log('[dbg]', ...args) };
            }

            // Set the initial page to be displayed
            loginPage.hidden = false;

            // Button to show login form
            showLoginBtn.addEventListener('click', () => {
                loginForm.hidden = false;
                signupForm.hidden = true;
                showLoginBtn.classList.add('bg-[#f46f47]', 'text-white');
                showLoginBtn.classList.remove('text-[#4c4c4c]', 'hover:bg-white');
                showSignupBtn.classList.remove('bg-[#f46f47]', 'text-white');
                showSignupBtn.classList.add('text-[#4c4c4c]', 'hover:bg-white');
            });

            // Button to show signup form
            showSignupBtn.addEventListener('click', () => {
                loginForm.hidden = true;
                signupForm.hidden = false;
                showSignupBtn.classList.add('bg-[#f46f47]', 'text-white');
                showSignupBtn.classList.remove('text-[#4c4c4c]', 'hover:bg-white');
                showLoginBtn.classList.remove('bg-[#f46f47]', 'text-white');
                showLoginBtn.classList.add('text-[#4c4c4c]', 'hover:bg-white');
            });

            // Using token-based auth for now (no CSRF/cookies) until backend exposes /csrf & /refresh
            const BACKEND_BASE = window.BACKEND_BASE_URL || 'http://localhost:8000';
            
            // Helper to show a temporary message under the forms
            function showMessage(text, type = 'info') {
                let el = document.getElementById('global-msg');
                if (!el) {
                    el = document.createElement('div');
                    el.id = 'global-msg';
                    el.className = 'mt-4 mb-4 text-center';
                    loginForm.parentElement.prepend(el);
                }
                // allow passing arrays or objects
                if (Array.isArray(text)) text = text.join(' ');
                if (typeof text === 'object') text = JSON.stringify(text);
                el.textContent = text;
                el.style.color = type === 'error' ? '#dc2626' : '#059669';
                if (type === 'error') {
                    el.style.background = '#fff5f5';
                    el.style.padding = '8px';
                    el.style.borderRadius = '6px';
                    el.style.border = '1px solid #fecaca';
                } else {
                    el.style.background = '';
                    el.style.border = '';
                }
            }

            // Login: POST /login (body: { username, password })
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                try {
                    const res = await fetch(`${BACKEND_BASE}/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: email, password })
                    });
                    const data = await res.json();
                    dbg.logReq(`POST /login ${email}`, { status: res.status, body: data });
                    if (!res.ok) {
                        // handle different error shapes
                        if (data.detail) {
                            // Pydantic 422 returns list of errors; HTTPException returns string
                            if (Array.isArray(data.detail)) {
                                const msgs = data.detail.map(d => d.msg || JSON.stringify(d)).join(' ');
                                showMessage(msgs, 'error');
                            } else if (typeof data.detail === 'string') {
                                if (res.status === 401 && data.detail.toLowerCase().includes('not verified')) {
                                    showMessage('Email not verified. Click the link sent to your email or request a new one.', 'error');
                                    if (resendBtn) {
                                        resendBtn.classList.remove('hidden');
                                        resendBtn.disabled = false;
                                    }
                                } else {
                                    showMessage(data.detail, 'error');
                                }
                            } else {
                                showMessage(JSON.stringify(data.detail), 'error');
                            }
                        } else {
                            showMessage('Login failed', 'error');
                        }
                        return;
                    }
                    // Store access token (JWT) in a cookie for subsequent API calls
                    const token = data.access_token || data.token || data.accessToken;
                    if (!token) {
                        showMessage('Login did not return a token', 'error');
                        return;
                    }
                    // Use shared auth helper to set a Strict cookie, secure on HTTPS
                    if (window.auth && typeof window.auth.setCookie === 'function') {
                        window.auth.setCookie('dh_token', token, 7);
                    } else {
                        // Fallback, Strict + Secure on HTTPS
                        const maxAge = `; Max-Age=${7*86400}`;
                        const attrs = `Path=/; SameSite=Strict${location.protocol==='https:'?'; Secure':''}${maxAge}`;
                        document.cookie = `dh_token=${encodeURIComponent(token)}; ${attrs}`;
                    }
                    showMessage('Logged in successfully');
                    window.location.href = 'profile.html';
                } catch (err) {
                    showMessage('Network error', 'error');
                    console.error(err);
                }
            });
            // Resend verification handler
            if (resendBtn) {
                resendBtn.addEventListener('click', async () => {
                    const email = document.getElementById('login-email').value;
                    if (!email) {
                        showMessage('Please enter your email in the field above before resending.', 'error');
                        return;
                    }
                    resendBtn.disabled = true;
                    resendBtn.textContent = 'Sending...';
                    try {
                        const res = await fetch(`${BACKEND_BASE}/resend-verification`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email })
                        });
                        dbg.logReq('POST /resend-verification', { status: res.status });
                        if (!res.ok) {
                            showMessage('Unable to resend. Please try again later.', 'error');
                        } else {
                            showMessage('If this account exists and is not verified, a new email has just been sent. Please check your inbox.', 'info');
                        }
                    } catch (e) {
                        showMessage('Network error during resend', 'error');
                    } finally {
                        resendBtn.disabled = false;
                        resendBtn.textContent = "Resend verification email";
                    }
                });
            }

            // Signup: POST /register (body: { name, email, password })
            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const firstname = document.getElementById('signup-firstname').value;
                const lastname = document.getElementById('signup-lastname').value;
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const name = `${firstname} ${lastname}`.trim();
                try {
                    const res = await fetch(`${BACKEND_BASE}/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, email, password })
                    });
                    const data = await res.json();
                    dbg.logReq(`POST /register ${email}`, { status: res.status, body: data });
                    if (!res.ok) {
                        if (data.detail) {
                            if (Array.isArray(data.detail)) {
                                const msgs = data.detail.map(d => d.msg || JSON.stringify(d)).join(' ');
                                showMessage(msgs, 'error');
                            } else if (typeof data.detail === 'string') {
                                showMessage(data.detail, 'error');
                            } else {
                                showMessage(JSON.stringify(data.detail), 'error');
                            }
                        } else {
                            showMessage('Signup failed', 'error');
                        }
                        return;
                    }
                    showMessage('Account created. Please check your email for a verification link to verify your account.');

                } catch (err) {
                    showMessage('Network error', 'error');
                    console.error(err);
                }
            });
        });
    </script>
</body>
</html>
